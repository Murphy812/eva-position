dist: xenial
cache:
  directories:
    - $HOME/.composer/cache
    - ansible/builds

phpenv: 7.2

language: python

python:
  - "2.7"

jobs:
  include:
    - stage: deploy stage
      install:
        - pip install ansible
      script:
        - echo $ANSIBLE_VAULT_PASS > ansible/.vault_pass
        - cd ansible
        - rm builds/*.*
        - make deploy env=production

    - stage: test
      script:
        - cd tests
        - composer install --no-interaction
        - cd ../ansible
        - make codecept env=production

    - stage: deploy production
      install:
        - pip install ansible
      script:
        - echo $ANSIBLE_VAULT_PASS > ansible/.vault_pass
        - cd ansible
        - make deploy env=production

addons:
  ssh_known_hosts:
  - 85.143.222.113
  apt:
    packages:
    - sshpass
